using (SqlConnection conn = new SqlConnection(_connectionString))
{
    string UserId = "";
    foreach (var item in User.Claims)
    {
        if (item.Type == "Id")
            UserId = item.Value;
    }

    conn.Open();
    SqlTransaction trns = null;
    using (SqlCommand cmd = new SqlCommand())
    {
        try
        {
            trns = conn.BeginTransaction();
            cmd.Connection = conn;
            cmd.Transaction = trns;
            /*
            //select the store with the most stock
            cmd.CommandText = "select store_id, quantity " +
                "from stocks " +
                "where product_id = @id AND quantity=" +
                "(select MAX(quantity) " +
                "from stocks " +
                "where product_id = @id)";
            cmd.Parameters.AddWithValue("@id", UserId.ToString());
            int store = (int)cmd.ExecuteScalar();
            */

            DefaultStore = "Santa Cruz";
            //select default store id
            cmd.CommandText = "select store_id " +
                "from stores " +
                "where city = @city";
            cmd.Parameters.AddWithValue("@city", DefaultStore);
            int store = (int)cmd.ExecuteScalar();


            
            int[] orders = { 0, 0, 0 };

            

            //prendi id dell'ordine --> SELECT SCOPE_IDENTITY()
            //Retrieve the last identity value generated in the current session and scope
            cmd.CommandText = "SELECT SCOPE_IDENTITY()";
            int ord_id = (int)cmd.ExecuteScalar();

            //order_items
            int i = 0;
            cmd.Parameters.AddWithValue("@ord_id", 0);
            cmd.Parameters.Add("@i", System.Data.SqlDbType.Int);
            cmd.Parameters.Add("@prod_id", System.Data.SqlDbType.Int);
            cmd.Parameters.Add("@qnt", System.Data.SqlDbType.Int);
            cmd.Parameters.Add("@price", System.Data.SqlDbType.Decimal);

            
            foreach (var item in MyCart.Items)
            {
                for (int j = 0; j < 3; j++)
                {
                    cmd.Parameters["@prod_id"].Value = item.Id;
                    cmd.CommandText = "SELECT quantity from stocks where product_id = @prod_id and store_id = @store";
                    int n = (int)cmd.ExecuteScalar();
                    if (n >= item.Quantity)
                }



                
                {
                    i++;


                    cmd.CommandText = "INSERT INTO order_items(order_id, item_id, product_id, quantity, list_price, discount)" +
                        "VALUES(@ord_id, @i, @prod_id, @qnt, @price, 0)";
                    cmd.Parameters["@i"].Value = i;
                    cmd.Parameters["@qnt"].Value = item.Quantity;
                    cmd.Parameters["@price"].Value = item.Price;
                    cmd.ExecuteNonQuery();

                    cmd.CommandText = "UPDATE stocks";
                    //rimuovi item dal cart
                    MyCart.Remove(item.Id, item.Quantity);
                }
            }

            trns.Commit();
        }
        catch (Exception ex)
        {

            throw;
        }
        SqlDataReader reader = cmd.ExecuteReader();
    }